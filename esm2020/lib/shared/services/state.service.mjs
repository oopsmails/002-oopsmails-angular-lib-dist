import { Injectable } from '@angular/core';
import { of, map, tap, catchError } from 'rxjs';
import { STATE_WITH_FLAG_DATA } from '../data/statesWithFlag.data';
import { US_STATE_WITH_CITIES } from '../data/usStateWithCities.data';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class StateService {
    constructor(httpClient) {
        this.httpClient = httpClient;
        // this.statesWithFlag$ = this.httpClient //
        //   .get('assets/mockdata/statesWithFlag.json') as Observable<UsState[]>; // angular support asset in lib since v9
        // .get('../data/statesWithFlag.json') as Observable<UsState[]>;
        this.getUsStates();
    }
    getUsStates() {
        // return this.statesWithFlag$;
        return this.httpClient.get('assets/mockdata/statesWithFlag.json').pipe(map((data) => {
            console.log('oops-lib002, StateService, getUsStates from statesWithFlag.json');
            return data;
        }), catchError((err) => {
            console.log('oops-lib002, StateService, json file not exist? OK, will get from data.ts!');
            console.error(err);
            console.log('oops-lib002, StateService, getUsStateCityData from usStateWithCities.data.ts');
            return of(STATE_WITH_FLAG_DATA);
        }));
    }
    searchUsStates(term) {
        console.log('searchStates ....', term);
        if (term === '') {
            return of([]);
        }
        return this.getUsStates().pipe(map((items) => {
            return (items.filter((item) => {
                // console.log('searchState ...', term, item.name.toLowerCase().indexOf(term.toLowerCase()));
                return item.stateName.toLowerCase().indexOf(term.toLowerCase()) >= 0;
            }) || []);
        }), tap((items) => console.log('search result.size: ', (items && items.length) || '0'))
        // tap((items) => console.log('search result.size: ', items))
        );
    }
    getUsStateCityFromTs() {
        return of(US_STATE_WITH_CITIES);
    }
    getUsStateCityData() {
        return this.httpClient.get('assets/mockdata/cities.json').pipe(map((data) => {
            console.log('oops-lib002, StateService, getUsStateCityData from cities.json');
            return Object.entries(data).sort();
        }), catchError((err) => {
            console.log('oops-lib002, StateService, json file not exist? OK, will get from data.ts!');
            console.warn(err);
            console.log('oops-lib002, StateService, getUsStateCityData from usStateWithCities.data.ts');
            return of(US_STATE_WITH_CITIES);
        }));
    }
    getUsStateCity() {
        return this.getUsStateCityData().pipe(
        // return this.httpClient.get('assets/mockdata/cities.json').pipe(
        // return this.httpClient.get('../data/cities.json').pipe( // angular support asset in lib since v9
        map((data) => {
            let statesData;
            let states = [];
            // console.log('Loading states and cities ..... ', data);
            if (data) {
                statesData = Object.entries(data).sort();
                let sIdx = 0;
                statesData.forEach((stateData) => {
                    // console.log(`stateData[0]: `, stateData[0]);
                    // console.log(`stateData[1]: `, stateData[1]);
                    const state = this.makeUsState(sIdx, stateData[0]);
                    sIdx++;
                    let cIdx = 0;
                    stateData[1].sort().forEach((cityData) => {
                        const city = this.makeUsCityWithStateName(cIdx, cityData, state.stateName);
                        cIdx++;
                        state.cities.push(city);
                    });
                    states.push(state);
                });
            }
            // console.log(`StateService, getUsStateCity, states: `, states);
            console.log('StateService, getUsStateCity result.size: ', (states && states.length) || '0');
            return states;
        }));
    }
    getUsStateCitySlice(indexes) {
        return this.getUsStateCity().pipe(map((items) => {
            const result = [];
            items.forEach((item) => {
                if (indexes.includes(item.id)) {
                    result.push(item);
                }
            });
            return result;
        }));
    }
    getUsCities() {
        let cities = [];
        let retCities = [];
        return this.getUsStateCity().pipe(map((states) => {
            // console.log(`states: `, states);
            states.forEach((state) => {
                state.cities.forEach((cityData) => {
                    // console.log(`cityData: `, cityData);
                    const newCity = this.makeUsCityWithStateName(0, cityData.cityName, cityData.inStateName);
                    cities.push(cityData);
                });
            });
            cities.sort((a, b) => a.cityName.localeCompare(b.cityName));
            let cIdx = 0;
            cities.forEach((city) => {
                const newCity = this.makeUsCityWithStateName(cIdx, city.cityName, city.inStateName);
                cIdx++;
                retCities.push(newCity);
            });
            console.log(`Num of cities: `, retCities.length);
            return retCities;
        }));
    }
    makeUsState(idx, stateName) {
        const state = {};
        state.id = idx;
        state.stateName = stateName;
        state.cities = [];
        return state;
    }
    makeUsCity(idx, cityName) {
        const city = {};
        city.id = idx;
        city.cityName = cityName;
        return city;
    }
    makeUsCityWithStateName(idx, cityName, stateName) {
        const city = this.makeUsCity(idx, cityName);
        city.inStateName = stateName;
        return city;
    }
}
StateService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: StateService, deps: [{ token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
StateService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: StateService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: StateService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL29vcHMtbGliMDAyL3NyYy9saWIvc2hhcmVkL3NlcnZpY2VzL3N0YXRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ25FLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDOzs7QUFNdEUsTUFBTSxPQUFPLFlBQVk7SUFHdkIsWUFBb0IsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN4Qyw0Q0FBNEM7UUFDNUMsbUhBQW1IO1FBQ25ILGdFQUFnRTtRQUNoRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVELFdBQVc7UUFDVCwrQkFBK0I7UUFDL0IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDLElBQUksQ0FDcEUsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDWCxPQUFPLENBQUMsR0FBRyxDQUFDLGlFQUFpRSxDQUFDLENBQUM7WUFDL0UsT0FBTyxJQUFpQixDQUFDO1FBQzNCLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEVBQTRFLENBQUMsQ0FBQztZQUMxRixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEVBQThFLENBQUMsQ0FBQztZQUM1RixPQUFPLEVBQUUs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UUFDZixLQUFLLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUM1QixLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVsQixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxVQUFVLENBQUMsR0FBVyxFQUFFLFFBQWdCO1FBQ3RDLE1BQU0sSUFBSSxHQUFXLEVBQVksQ0FBQztRQUNsQyxJQUFJLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQztRQUNkLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBRXpCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHVCQUF1QixDQUFDLEdBQVcsRUFBRSxRQUFnQixFQUFFLFNBQWlCO1FBQ3RFLE1BQU0sSUFBSSxHQUFXLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDO1FBQzdCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7MEdBcEtVLFlBQVk7OEdBQVosWUFBWSxjQUZYLE1BQU07NEZBRVAsWUFBWTtrQkFIeEIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBtYXAsIHRhcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTVEFURV9XSVRIX0ZMQUdfREFUQSB9IGZyb20gJy4uL2RhdGEvc3RhdGVzV2l0aEZsYWcuZGF0YSc7XHJcbmltcG9ydCB7IFVTX1NUQVRFX1dJVEhfQ0lUSUVTIH0gZnJvbSAnLi4vZGF0YS91c1N0YXRlV2l0aENpdGllcy5kYXRhJztcclxuaW1wb3J0IHsgVXNDaXR5LCBVc1N0YXRlIH0gZnJvbSAnLi4vbW9kZWxzJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTdGF0ZVNlcnZpY2Uge1xyXG4gIGVycm9yTWVzc2FnZT86IHN0cmluZztcclxuICBzdGF0ZXNXaXRoRmxhZyQ6IE9ic2VydmFibGU8VXNTdGF0ZVtdPjtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQpIHtcclxuICAgIC8vIHRoaXMuc3RhdGVzV2l0aEZsYWckID0gdGhpcy5odHRwQ2xpZW50IC8vXHJcbiAgICAvLyAgIC5nZXQoJ2Fzc2V0cy9tb2NrZGF0YS9zdGF0ZXNXaXRoRmxhZy5qc29uJykgYXMgT2JzZXJ2YWJsZTxVc1N0YXRlW10+OyAvLyBhbmd1bGFyIHN1cHBvcnQgYXNzZXQgaW4gbGliIHNpbmNlIHY5XHJcbiAgICAvLyAuZ2V0KCcuLi9kYXRhL3N0YXRlc1dpdGhGbGFnLmpzb24nKSBhcyBPYnNlcnZhYmxlPFVzU3RhdGVbXT47XHJcbiAgICB0aGlzLmdldFVzU3RhdGVzKCk7XHJcbiAgfVxyXG5cclxuICBnZXRVc1N0YXRlcygpOiBPYnNlcnZhYmxlPFVzU3RhdGVbXT4ge1xyXG4gICAgLy8gcmV0dXJuIHRoaXMuc3RhdGVzV2l0aEZsYWckO1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5nZXQoJ2Fzc2V0cy9tb2NrZGF0YS9zdGF0ZXNXaXRoRmxhZy5qc29uJykucGlwZShcclxuICAgICAgbWFwKChkYXRhKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ29vcHMtbGliMDAyLCBTdGF0ZVNlcnZpY2UsIGdldFVzU3RhdGVzIGZyb20gc3RhdGVzV2l0aEZsYWcuanNvbicpO1xyXG4gICAgICAgIHJldHVybiBkYXRhIGFzIFVzU3RhdGVbXTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdvb3BzLWxpYjAwMiwgU3RhdGVTZXJ2aWNlLCBqc29uIGZpbGUgbm90IGV4aXN0PyBPSywgd2lsbCBnZXQgZnJvbSBkYXRhLnRzIScpO1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuICAgICAgICBjb25zb2xlLmxvZygnb29wcy1saWIwMDIsIFN0YXRlU2VydmljZSwgZ2V0VXNTdGF0ZUNpdHlEYXRhIGZyb20gdXNTdGF0ZVdpdGhDaXRpZXMuZGF0YS50cycpO1xyXG4gICAgICAgIHJldHVybiBvZihTVEFURV9XSVRIX0ZMQUdfREFUQSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2VhcmNoVXNTdGF0ZXModGVybTogc3RyaW5nKTogT2JzZXJ2YWJsZTxVc1N0YXRlW10+IHtcclxuICAgIGNvbnNvbGUubG9nKCdzZWFyY2hTdGF0ZXMgLi4uLicsIHRlcm0pO1xyXG4gICAgaWYgKHRlcm0gPT09ICcnKSB7XHJcbiAgICAgIHJldHVybiBvZihbXSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZXRVc1N0YXRlcygpLnBpcGUoXHJcbiAgICAgIG1hcCgoaXRlbXM6IFVzU3RhdGVbXSkgPT4ge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICBpdGVtcy5maWx0ZXIoKGl0ZW06IFVzU3RhdGUpID0+IHtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NlYXJjaFN0YXRlIC4uLicsIHRlcm0sIGl0ZW0ubmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGVybS50b0xvd2VyQ2FzZSgpKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtLnN0YXRlTmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGVybS50b0xvd2VyQ2FzZSgpKSA+PSAwO1xyXG4gICAgICAgICAgfSkgfHwgW11cclxuICAgICAgICApO1xyXG4gICAgICB9KSxcclxuICAgICAgdGFwKChpdGVtcykgPT4gY29uc29sZS5sb2coJ3NlYXJjaCByZXN1bHQuc2l6ZTogJywgKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCkgfHwgJzAnKSlcclxuICAgICAgLy8gdGFwKChpdGVtcykgPT4gY29uc29sZS5sb2coJ3NlYXJjaCByZXN1bHQuc2l6ZTogJywgaXRlbXMpKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGdldFVzU3RhdGVDaXR5RnJvbVRzKCk6IE9ic2VydmFibGU8W3N0cmluZywgYW55XVtdPiB7XHJcbiAgICByZXR1cm4gb2YoVVNfU1RBVEVfV0lUSF9DSVRJRVMpO1xyXG4gIH1cclxuXHJcbiAgZ2V0VXNTdGF0ZUNpdHlEYXRhKCk6IE9ic2VydmFibGU8W3N0cmluZywgYW55XVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50LmdldCgnYXNzZXRzL21vY2tkYXRhL2NpdGllcy5qc29uJykucGlwZShcclxuICAgICAgbWFwKChkYXRhKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ29vcHMtbGliMDAyLCBTdGF0ZVNlcnZpY2UsIGdldFVzU3RhdGVDaXR5RGF0YSBmcm9tIGNpdGllcy5qc29uJyk7XHJcbiAgICAgICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGRhdGEpLnNvcnQoKTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdvb3BzLWxpYjAwMiwgU3RhdGVTZXJ2aWNlLCBqc29uIGZpbGUgbm90IGV4aXN0PyBPSywgd2lsbCBnZXQgZnJvbSBkYXRhLnRzIScpO1xyXG4gICAgICAgIGNvbnNvbGUud2FybihlcnIpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdvb3BzLWxpYjAwMiwgU3RhdGVTZXJ2aWNlLCBnZXRVc1N0YXRlQ2l0eURhdGEgZnJvbSB1c1N0YXRlV2l0aENpdGllcy5kYXRhLnRzJyk7XHJcbiAgICAgICAgcmV0dXJuIG9mKFVTX1NUQVRFX1dJVEhfQ0lUSUVTKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRVc1N0YXRlQ2l0eSgpOiBPYnNlcnZhYmxlPFVzU3RhdGVbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0VXNTdGF0ZUNpdHlEYXRhKCkucGlwZShcclxuICAgICAgLy8gcmV0dXJuIHRoaXMuaHR0cENsaWVudC5nZXQoJ2Fzc2V0cy9tb2NrZGF0YS9jaXRpZXMuanNvbicpLnBpcGUoXHJcbiAgICAgIC8vIHJldHVybiB0aGlzLmh0dHBDbGllbnQuZ2V0KCcuLi9kYXRhL2NpdGllcy5qc29uJykucGlwZSggLy8gYW5ndWxhciBzdXBwb3J0IGFzc2V0IGluIGxpYiBzaW5jZSB2OVxyXG4gICAgICBtYXAoKGRhdGEpID0+IHtcclxuICAgICAgICBsZXQgc3RhdGVzRGF0YTogW3N0cmluZywgYW55XVtdO1xyXG4gICAgICAgIGxldCBzdGF0ZXM6IFVzU3RhdGVbXSA9IFtdO1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdMb2FkaW5nIHN0YXRlcyBhbmQgY2l0aWVzIC4uLi4uICcsIGRhdGEpO1xyXG4gICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICBzdGF0ZXNEYXRhID0gT2JqZWN0LmVudHJpZXMoZGF0YSkuc29ydCgpO1xyXG5cclxuICAgICAgICAgIGxldCBzSWR4ID0gMDtcclxuICAgICAgICAgIHN0YXRlc0RhdGEuZm9yRWFjaCgoc3RhdGVEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBzdGF0ZURhdGFbMF06IGAsIHN0YXRlRGF0YVswXSk7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBzdGF0ZURhdGFbMV06IGAsIHN0YXRlRGF0YVsxXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5tYWtlVXNTdGF0ZShzSWR4LCBzdGF0ZURhdGFbMF0pO1xyXG4gICAgICAgICAgICBzSWR4Kys7XHJcblxyXG4gICAgICAgICAgICBsZXQgY0lkeCA9IDA7XHJcbiAgICAgICAgICAgIHN0YXRlRGF0YVsxXS5zb3J0KCkuZm9yRWFjaCgoY2l0eURhdGEpID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBjaXR5ID0gdGhpcy5tYWtlVXNDaXR5V2l0aFN0YXRlTmFtZShjSWR4LCBjaXR5RGF0YSwgc3RhdGUuc3RhdGVOYW1lKTtcclxuICAgICAgICAgICAgICBjSWR4Kys7XHJcbiAgICAgICAgICAgICAgc3RhdGUuY2l0aWVzLnB1c2goY2l0eSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzdGF0ZXMucHVzaChzdGF0ZSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coYFN0YXRlU2VydmljZSwgZ2V0VXNTdGF0ZUNpdHksIHN0YXRlczogYCwgc3RhdGVzKTtcclxuICAgICAgICBjb25zb2xlLmxvZygnU3RhdGVTZXJ2aWNlLCBnZXRVc1N0YXRlQ2l0eSByZXN1bHQuc2l6ZTogJywgKHN0YXRlcyAmJiBzdGF0ZXMubGVuZ3RoKSB8fCAnMCcpO1xyXG4gICAgICAgIHJldHVybiBzdGF0ZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0VXNTdGF0ZUNpdHlTbGljZShpbmRleGVzOiBudW1iZXJbXSk6IE9ic2VydmFibGU8VXNTdGF0ZVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRVc1N0YXRlQ2l0eSgpLnBpcGUoXHJcbiAgICAgIG1hcCgoaXRlbXM6IFVzU3RhdGVbXSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW06IFVzU3RhdGUpID0+IHtcclxuICAgICAgICAgIGlmIChpbmRleGVzLmluY2x1ZGVzKGl0ZW0uaWQpKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0VXNDaXRpZXMoKSB7XHJcbiAgICBsZXQgY2l0aWVzOiBVc0NpdHlbXSA9IFtdO1xyXG4gICAgbGV0IHJldENpdGllczogVXNDaXR5W10gPSBbXTtcclxuICAgIHJldHVybiB0aGlzLmdldFVzU3RhdGVDaXR5KCkucGlwZShcclxuICAgICAgbWFwKChzdGF0ZXMpID0+IHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhgc3RhdGVzOiBgLCBzdGF0ZXMpO1xyXG4gICAgICAgIHN0YXRlcy5mb3JFYWNoKChzdGF0ZSkgPT4ge1xyXG4gICAgICAgICAgc3RhdGUuY2l0aWVzLmZvckVhY2goKGNpdHlEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBjaXR5RGF0YTogYCwgY2l0eURhdGEpO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdDaXR5ID0gdGhpcy5tYWtlVXNDaXR5V2l0aFN0YXRlTmFtZShcclxuICAgICAgICAgICAgICAwLFxyXG4gICAgICAgICAgICAgIGNpdHlEYXRhLmNpdHlOYW1lLFxyXG4gICAgICAgICAgICAgIGNpdHlEYXRhLmluU3RhdGVOYW1lXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGNpdGllcy5wdXNoKGNpdHlEYXRhKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjaXRpZXMuc29ydCgoYSwgYikgPT4gYS5jaXR5TmFtZS5sb2NhbGVDb21wYXJlKGIuY2l0eU5hbWUpKTtcclxuICAgICAgICBsZXQgY0lkeCA9IDA7XHJcbiAgICAgICAgY2l0aWVzLmZvckVhY2goKGNpdHkpID0+IHtcclxuICAgICAgICAgIGNvbnN0IG5ld0NpdHkgPSB0aGlzLm1ha2VVc0NpdHlXaXRoU3RhdGVOYW1lKGNJZHgsIGNpdHkuY2l0eU5hbWUsIGNpdHkuaW5TdGF0ZU5hbWUpO1xyXG4gICAgICAgICAgY0lkeCsrO1xyXG4gICAgICAgICAgcmV0Q2l0aWVzLnB1c2gobmV3Q2l0eSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYE51bSBvZiBjaXRpZXM6IGAsIHJldENpdGllcy5sZW5ndGgpO1xyXG4gICAgICAgIHJldHVybiByZXRDaXRpZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgbWFrZVVzU3RhdGUoaWR4OiBudW1iZXIsIHN0YXRlTmFtZTogc3RyaW5nKTogVXNTdGF0ZSB7XHJcbiAgICBjb25zdCBzdGF0ZTogVXNTdGF0ZSA9IHt9IGFzIFVzU3RhdGU7XHJcbiAgICBzdGF0ZS5pZCA9IGlkeDtcclxuICAgIHN0YXRlLnN0YXRlTmFtZSA9IHN0YXRlTmFtZTtcclxuICAgIHN0YXRlLmNpdGllcyA9IFtdO1xyXG5cclxuICAgIHJldHVybiBzdGF0ZTtcclxuICB9XHJcblxyXG4gIG1ha2VVc0NpdHkoaWR4OiBudW1iZXIsIGNpdHlOYW1lOiBzdHJpbmcpOiBVc0NpdHkge1xyXG4gICAgY29uc3QgY2l0eTogVXNDaXR5ID0ge30gYXMgVXNDaXR5O1xyXG4gICAgY2l0eS5pZCA9IGlkeDtcclxuICAgIGNpdHkuY2l0eU5hbWUgPSBjaXR5TmFtZTtcclxuXHJcbiAgICByZXR1cm4gY2l0eTtcclxuICB9XHJcblxyXG4gIG1ha2VVc0NpdHlXaXRoU3RhdGVOYW1lKGlkeDogbnVtYmVyLCBjaXR5TmFtZTogc3RyaW5nLCBzdGF0ZU5hbWU6IHN0cmluZyk6IFVzQ2l0eSB7XHJcbiAgICBjb25zdCBjaXR5OiBVc0NpdHkgPSB0aGlzLm1ha2VVc0NpdHkoaWR4LCBjaXR5TmFtZSk7XHJcbiAgICBjaXR5LmluU3RhdGVOYW1lID0gc3RhdGVOYW1lO1xyXG4gICAgcmV0dXJuIGNpdHk7XHJcbiAgfVxyXG59XHJcbiJdfQ==